#!/bin/bash

OUTPUT=xia.mk

echo "# Autogenerated on $(date)" > $OUTPUT
echo "# DO NOT HAND EDIT!" >> $OUTPUT
echo >> $OUTPUT

# set num of procs for parallel builds
if [ $(uname) = "Darwin" ]; then
	# os x
	CORES=$(sysctl -n hw.ncpu)
else
	# linux
	CORES=`grep -c ^processor /proc/cpuinfo`
fi
echo NPROCS=$(($CORES * 2)) >> $OUTPUT

echo XIADIR=$(pwd) >> $OUTPUT

[ "$1" == "DEBUG" ] && echo "DEBUG=1" >> $OUTPUT

cat >> $OUTPUT << EOF
APIDIR=\$(XIADIR)/api
BINDIR=\$(XIADIR)/bin
XCACHEAPIDIR=\$(XIADIR)/daemons/xcache/api
ETC=\$(XIADIR)/etc
XLIB=\$(APIDIR)/lib
# RID includes have symbolic links to XINC
XINC=\$(APIDIR)/include
XCACHEINC=\$(XCACHEAPIDIR)
# RID API directory
RIDAPIDIR=\$(APIDIR)/rid

CC=g++
LD=g++
CFLAGS=-Wall -Wextra -I\$(XINC) -I\$(XCACHEINC) -L\$(XLIB) -L\$(XCACHEAPIDIR) -L\$(RIDAPIDIR)/bin
ENV_LD_LIBRARY_PATH+=\$(XLIB):\$(XCACHEAPIDIR)
ENV_LDFLAGS=-lpthread -lprotobuf
ifeq (\$(wildcard \$(XLIB)/libXsocket.a),)
	LIBS=\$(XLIB)/libXsocket.so \$(XLIB)/libdagaddr.so \$(XLIB)/libXssl.so
	ENV_LDFLAGS+=-lXsocket -ldagaddr -lXssl -lxcache
else
	LIBS=\$(XLIB)/libXsocket.a \$(XLIB)/libdagaddr.a \$(XLIB)/libXssl.a -Bstatic -lprotobuf
	ENV_LDFLAGS+=-lXsocket -ldagaddr -lXssl -lxcache
endif
#LIBS+=\$(XCACHEAPIDIR)/libxcache.a
LIBS+=\$(XCACHEAPIDIR)/libxcache.so

# location for (shared) RID library
LIBS+=\$(RIDAPIDIR)/bin/librid.so

ifdef DEBUG
CFLAGS +=-ggdb -DDEBUG
else
CFLAGS +=-O2
endif

EOF
